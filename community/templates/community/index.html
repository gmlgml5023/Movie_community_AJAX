{% extends 'base.html' %}

{% block content %}
  <div class="container mt-5">
    <h1>Community</h1>
    <hr>

    {% comment %} 1. ìµœìƒìœ„ ìš”ì†Œ ì‘ì„± {% endcomment %}
    <div class="review-container">
      {% for review in reviews %}
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">{{ review.title }}</h5>
            <p class="card-text">{{ review.content }}</p>
            <p class="text-muted">ì‘ì„±ì: <a href="{% url 'accounts:profile' review.user.username %}">{{ review.user }}</a></p>
            <p class="text-muted">ê¸€ ë²ˆí˜¸: {{ review.pk }}</p>

            <form data-review-id="{{ review.pk }}" class="d-inline">
              {% csrf_token %}
              {% if request.user in review.like_users.all %}
                <button type="submit" class="btn btn-link text-danger" id="like-{{ review.pk }}">
                  â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ
                </button>
              {% else %}
                <button type="submit" class="btn btn-link text-primary" id="like-{{ review.pk }}">
                  ğŸ’” ì¢‹ì•„ìš”
                </button>
              {% endif %}
            </form>

            <p class="mt-2">
              <span id="like-{{ review.pk }}-count">{{ review.like_users.all|length }}</span>ëª…ì´ ì´ ê¸€ì„ ì¢‹ì•„í•©ë‹ˆë‹¤.
            </p>

            <a href="{% url 'community:detail' review.pk %}" class="btn btn-link">[detail]</a>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // 2. ë¦¬ë·°ë¥¼ ëª¨ë‘ í¬í•¨í•˜ëŠ” ìµœìƒìœ„ ìš”ì†Œ ì„ íƒ
    const reviewContainer = document.querySelector('.review-container')

    // 7. csrftoken ì„ íƒ
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

    // 3. ì„ íƒí•œ ìµœìƒìœ„ ìš”ì†Œì— ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë¶€ì°©
    reviewContainer.addEventListener('submit', function (event) {
      // 4. submit ì´ë²¤íŠ¸ ê¸°ë³¸ ë™ì‘ ì·¨ì†Œ
      event.preventDefault()
      // 10. HTMLì—ì„œ ì „ë‹¬í•œ ë¦¬ë·° id ë°›ê¸°
      const reviewId = event.target.dataset.reviewId
      
      axios({
        method: 'post',
        // 11. ì „ë‹¬ë°›ì€ ë¦¬ë·° idë¡œ url ì™„ì„±
        url: `/community/${reviewId}/like/`,
        // 8. ì„ íƒí•œ csrftokenì„ headersì— ì„¸íŒ…
        headers: {'X-CSRFToken': csrftoken,},
      })
      .then((response) => {
        // 14. djangoí•œí…Œ ì‘ë‹µë°›ì€ ì¢‹ì•„ìš” ìƒíƒœ ì •ë³´ ì €ì¥
        const isLiked = response.data.is_liked
        const likeCount = response.data.like_count

        // ì¢‹ì•„ìš” ê°œìˆ˜ ë„£ì„ ê³³ spaníƒœê·¸ ì„ íƒ
        const likeCountNum = document.querySelector(`#like-${reviewId}-count`)
        likeCountNum.textContent = likeCount

        // 16. ì¢‹ì•„ìš” ë²„íŠ¼ ì„ íƒ
        const likeBtn = document.querySelector(`#like-${reviewId}`)

        // 15. ì¢‹ì•„ìš” ìƒíƒœ ì •ë³´ì— ë”°ë¼ ë²„íŠ¼ ë³€ê²½
        if (isLiked) {
          likeBtn.innerHTML = 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ'
          likeBtn.classList.remove('text-primary')
          likeBtn.classList.add('text-danger')
        } else {
          likeBtn.innerHTML = 'ğŸ’” ì¢‹ì•„ìš”'
          likeBtn.classList.remove('text-danger')
          likeBtn.classList.add('text-primary')
        }

      })
      .catch((error) => {
        console.log(error)
      })
    })
  </script>
{% endblock %}
